name: build-debs

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64, arm64]

    steps:
      - uses: actions/checkout@v4

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v2

      - name: Build project and package .deb
        env:
          REF_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            # Build inside an emulated arm64 container so native arm64 libs/headers are available
            docker run --rm --platform linux/arm64 -v "${PWD}":/src -w /src ubuntu:24.04 bash -lc "set -euo pipefail; apt-get update; apt-get install -y build-essential libssl-dev dpkg-dev ca-certificates; make clean || true; make ARCH=aarch64; mkdir -p /src/artifacts/aafkeygen_${REF_NAME}_arm64/usr/bin; cp aafkeygen /src/artifacts/aafkeygen_${REF_NAME}_arm64/usr/bin/; cp -r debian /src/artifacts/aafkeygen_${REF_NAME}_arm64/DEBIAN || true; dpkg-deb --build /src/artifacts/aafkeygen_${REF_NAME}_arm64"
          else
            make clean || true
            make ARCH=x86_64
            mkdir -p artifacts/aafkeygen_${REF_NAME}_amd64/usr/bin
            cp aafkeygen artifacts/aafkeygen_${REF_NAME}_amd64/usr/bin/
            cp -r debian artifacts/aafkeygen_${REF_NAME}_amd64/DEBIAN || true
            dpkg-deb --build artifacts/aafkeygen_${REF_NAME}_amd64
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debs-${{ matrix.arch }}
          path: artifacts/*.deb
