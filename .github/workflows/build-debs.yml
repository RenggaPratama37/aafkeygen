name: build-debs

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64, arm64]

    steps:
      - uses: actions/checkout@v4

      # --- Generate numeric version ---
      - name: Generate VERSION file
        run: |
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
          echo "${GITHUB_REF_NAME#v}" > VERSION
          exit 0
          fi

          if [[ -f VERSION ]]; then
          echo "Using VERSION from repository:"
          cat VERSION
          exit 0
          fi
        
          echo "0.0.$(git rev-list --count HEAD)" > VERSION
          echo "Fallback VERSION:"
          cat VERSION

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v2

      # --- Build & Package ---
      - name: Build project and package .deb
        env:
          VERSION: ${{ steps.VERSION.outputs.version }}
          REF_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail

          VERSION=$(cat VERSION)
          ARCH="${{ matrix.arch }}"

          echo "Building for ARCH=$ARCH VERSION=$VERSION"

          # Prepare control file with replaced placeholders
          mkdir -p debian-out
          sed \
            -e "s/@VERSION@/$VERSION/" \
            -e "s/@ARCH@/$ARCH/" \
            debian/control > debian-out/control

          # Which directory to build into
          PKG_DIR="artifacts/aafkeygen_v${VERSION}_${ARCH}"
          mkdir -p "$PKG_DIR/DEBIAN" "$PKG_DIR/usr/bin" "$PKG_DIR/usr/share/aafkeygen"

          # ARCH routing
          if [ "$ARCH" = "arm64" ]; then
            docker run --rm --platform linux/arm64 \
              -v "${PWD}":/src -w /src ubuntu:24.04 bash -lc "
                set -euo pipefail
                apt-get update
                apt-get install -y build-essential libssl-dev dpkg-dev ca-certificates zlib1g-dev
                make clean || true
                make ARCH=aarch64
              "
          else
            make clean || true
            make ARCH=x86_64
          fi

          # Copy files
          cp debian-out/control "$PKG_DIR/DEBIAN/control"
          cp aafkeygen "$PKG_DIR/usr/bin/aafkeygen"
          cp VERSION "$PKG_DIR/usr/share/aafkeygen/VERSION"

          echo "Building .deb..."
          dpkg-deb --build "$PKG_DIR"

          echo "Done â†’ $PKG_DIR.deb"

      # --- Upload output ---
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debs-${{ matrix.arch }}
          path: artifacts/*.deb
