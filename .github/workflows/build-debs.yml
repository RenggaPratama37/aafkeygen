name: build-debs

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64, arm64]

    steps:
      - uses: actions/checkout@v4

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v2

      - name: Install cross toolchain for arm64
        if: matrix.arch == 'arm64'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu libc6-dev-arm64-cross binutils-aarch64-linux-gnu

      - name: Build project and package .deb
        env:
          REF_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            make clean || true
            make CC=aarch64-linux-gnu-gcc ARCH=aarch64
            mkdir -p artifacts/aafkeygen_${REF_NAME}_arm64/usr/bin
            cp aafkeygen artifacts/aafkeygen_${REF_NAME}_arm64/usr/bin/
            cp -r debian artifacts/aafkeygen_${REF_NAME}_arm64/DEBIAN || true
            dpkg-deb --build artifacts/aafkeygen_${REF_NAME}_arm64
          else
            make clean || true
            make ARCH=x86_64
            mkdir -p artifacts/aafkeygen_${REF_NAME}_amd64/usr/bin
            cp aafkeygen artifacts/aafkeygen_${REF_NAME}_amd64/usr/bin/
            cp -r debian artifacts/aafkeygen_${REF_NAME}_amd64/DEBIAN || true
            dpkg-deb --build artifacts/aafkeygen_${REF_NAME}_amd64
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debs-${{ matrix.arch }}
          path: artifacts/*.deb
